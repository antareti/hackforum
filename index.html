<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Сохранение анимации как видео</title>
<style>
  body { 
    text-align: center; 
    background: linear-gradient(135deg, #1a1a1a, #111); 
    color: #fff; 
    font-family: 'Segoe UI', Tahoma, sans-serif; 
    padding: 30px;
  }
  h1 {
    font-size: 2em; 
    margin-bottom: 20px;
    text-shadow: 1px 1px 4px #000;
  }
  canvas { 
    border-radius: 12px; 
    border: 2px solid #555; 
    margin-top: 20px; 
    background: #222; 
    box-shadow: 0 0 20px rgba(0,0,0,0.7);
  }
  .controls {
    margin-top: 20px; 
    display: flex; 
    flex-wrap: wrap; 
    justify-content: center; 
    gap: 15px;
  }
  input[type="file"] {
    padding: 10px; 
    border-radius: 8px; 
    border: 1px solid #555; 
    background: #333; 
    color: #fff; 
    cursor: pointer;
    transition: 0.3s;
  }
  input[type="file"]:hover { background: #444; }
  button {
    padding: 12px 25px; 
    font-size: 16px; 
    border-radius: 8px; 
    border: none; 
    cursor: pointer; 
    background: linear-gradient(90deg, #ff6a00, #ee0979); 
    color: #fff; 
    font-weight: bold; 
    transition: 0.3s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  }
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.6);
  }
</style>
</head>
<body>

<h1>Живое фото с анимацией и видео</h1>

<div class="controls">
  <input type="file" id="fileInput" accept="image/*">
  <button onclick="startAnimation()">Начать анимацию</button>
  <button onclick="startRecording()">Начать запись видео</button>
  <button onclick="stopRecording()">Остановить и скачать видео</button>
</div>

<canvas id="canvas" width="400" height="600"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let img = new Image();
let angle = 0;
let animating = false;
let blinkTimer = 0;

let mediaRecorder;
let recordedChunks = [];

// Загрузка изображения
document.getElementById('fileInput').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(event){
    img.src = event.target.result;
    img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  }
  reader.readAsDataURL(file);
});

// Анимация с глитч-эффектом
function animate(){
  if(!animating) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Фон
  const bgGradient = ctx.createLinearGradient(0,0,0,canvas.height);
  bgGradient.addColorStop(0,'#333');
  bgGradient.addColorStop(1,'#111');
  ctx.fillStyle = bgGradient;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Плавное колебание фото
  const dx = Math.sin(angle*0.7) * 4;
  const dy = Math.cos(angle*1.2) * 3;
  const scale = 1 + Math.sin(angle*0.5)*0.015;

  ctx.save();
  ctx.translate(canvas.width/2 + dx, canvas.height/2 + dy);
  ctx.scale(scale, scale);
  ctx.drawImage(img, -canvas.width/2, -canvas.height/2, canvas.width, canvas.height);

  // Моргание глаз
  blinkTimer += 0.05;
  if(blinkTimer % 5 > 4.8){
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(-20, -50, 40, 5);
  }
  ctx.restore();

  // Лёгкое движение волос/одежды
  ctx.globalAlpha = 0.1;
  for(let i=0;i<3;i++){
    ctx.drawImage(canvas, rand(-3,3), rand(-3,3), canvas.width, canvas.height);
  }
  ctx.globalAlpha = 1;

  // Глитч эффект: случайные горизонтальные смещения строк
  const glitchLines = 5;
  for(let i=0; i<glitchLines; i++){
    const y = Math.floor(Math.random() * canvas.height);
    const h = Math.floor(Math.random() * 8 + 2);
    const offset = Math.floor(Math.random() * 20 - 10);
    ctx.drawImage(canvas, 0, y, canvas.width, h, offset, y, canvas.width, h);
  }

  angle += 0.05;
  requestAnimationFrame(animate);
}

function startAnimation(){
  if(!img.src) return alert("Сначала загрузите изображение!");
  if(animating) return;
  animating = true;
  animate();
}

function rand(min,max){ return Math.random()*(max-min)+min; }

// Запись видео
function startRecording(){
  if(!animating) return alert("Сначала запустите анимацию!");
  recordedChunks = [];
  const stream = canvas.captureStream(30); // 30 fps
  mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
  mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
  mediaRecorder.start();
  alert("Запись началась");
}

function stopRecording(){
  if(!mediaRecorder) return;
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'animated_photo.webm';
    a.click();
    URL.revokeObjectURL(url);
  };
  mediaRecorder.stop();
  alert("Запись остановлена, видео готово к скачиванию");
}
</script>

</body>
</html>
