<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Форум доброго хакера</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Anonymous+Pro:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        :root {
            --hacker-font: 'VT323', monospace;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .container {
            max-width: 800px;
        }
        .message-card {
            background-color: #161b22;
            border: 1px solid #30363d;
        }
        .admin-controls {
            display: none;
        }
        .is-admin .admin-controls {
            display: flex;
        }
        .pulse-animation {
            animation: pulse-border 1.5s infinite;
        }
        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 #3a8cff;
            }
            70% {
                box-shadow: 0 0 0 10px rgba(58, 140, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(58, 140, 255, 0);
            }
        }
        .avatar-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            justify-items: center;
        }
        .avatar-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            background-size: cover;
        }
        .avatar-option:hover {
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(58, 140, 255, 0.5);
        }
        .avatar-option.selected {
            border: 2px solid #3a8cff;
        }
        .avatar-locked {
            filter: grayscale(100%);
            opacity: 0.5;
            cursor: not-allowed;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }
        .points-added {
            animation: flash-green 0.5s ease-in-out;
        }
        @keyframes flash-green {
            0% { background-color: #161b22; }
            50% { background-color: #1a3219; }
            100% { background-color: #161b22; }
        }
        .hacker-font {
            font-family: var(--hacker-font);
            text-shadow: 0 0 5px #00ff00;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .typing-dot {
            animation: blink 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto">
        <h1 id="forum-title" class="text-4xl font-bold text-center my-8 text-white hacker-font">ФОРУМ ДОБРОГО ХАКЕРА</h1>
        
        <!-- Font Selection Dropdown -->
        <div class="flex justify-center mb-6">
            <label for="font-select" class="text-gray-400 mr-2 self-center">Выберите шрифт:</label>
            <select id="font-select" class="p-2 rounded-md bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="'VT323', monospace">VT323</option>
                <option value="'Source Code Pro', monospace">Source Code Pro</option>
                <option value="'Fira Code', monospace">Fira Code</option>
                <option value="'Anonymous Pro', monospace">Anonymous Pro</option>
            </select>
        </div>

        <p class="text-center text-gray-400 mb-6">
            Обычные пользователи могут оставлять сообщения. Введите пароль администратора, чтобы получить полные права.
        </p>

        <div id="admin-login-section" class="mb-6 p-4 rounded-lg bg-gray-800 border border-gray-700 shadow-md flex items-center justify-between">
            <span id="admin-status" class="text-sm font-semibold text-gray-400">Статус: Обычный пользователь</span>
            <div class="flex items-center space-x-2">
                <input type="password" id="admin-pass" placeholder="Пароль админа" class="p-2 rounded-md bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="admin-login-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Войти</button>
            </div>
        </div>

        <div class="mb-4">
            <p id="user-info" class="text-sm font-bold text-gray-400">
                <span id="user-id-display">Ваш ID: Загрузка...</span> | 
                <span id="user-points-display">0 баллов</span>
            </p>
        </div>

        <div id="messages-container" class="space-y-4 mb-6">
            <!-- Сообщения будут добавлены сюда -->
        </div>
        
        <form id="new-message-form" class="p-6 rounded-lg bg-gray-800 border border-gray-700 shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-white">Новое сообщение</h2>
            <div class="mb-4">
                <div class="flex items-center space-x-2 mb-2">
                    <img id="current-avatar-preview" class="user-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ccc' d='M12 2A10 10 0 1 0 12 22A10 10 0 1 0 12 2Zm0 3.75a3 3 0 1 1-3 3A3 3 0 0 1 12 5.75ZM12 20.5a8.5 8.5 0 0 1-6.19-2.5A6.5 6.5 0 0 1 12 14.5a6.5 6.5 0 0 1 6.19 3.5A8.5 8.5 0 0 1 12 20.5Z'/%3E%3C/svg%3E" alt="Аватар">
                    <span id="avatar-status-message" class="text-sm text-gray-400">Наберите 1 балл, чтобы выбрать аватар.</span>
                </div>
                <div id="avatar-selection" class="avatar-container mt-2 opacity-50 pointer-events-none">
                    <!-- Аватары будут добавлены здесь -->
                </div>
            </div>
            <textarea id="message-text" rows="4" class="w-full p-3 rounded-lg bg-gray-900 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none mb-4" placeholder="Введите ваше сообщение..."></textarea>
            <button type="submit" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">Отправить</button>
        </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const messagesContainer = document.getElementById('messages-container');
            const newMessageForm = document.getElementById('new-message-form');
            const messageTextarea = document.getElementById('message-text');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminPassInput = document.getElementById('admin-pass');
            const adminStatus = document.getElementById('admin-status');
            const avatarSelection = document.getElementById('avatar-selection');
            const currentAvatarPreview = document.getElementById('current-avatar-preview');
            const avatarStatusMessage = document.getElementById('avatar-status-message');
            const forumTitle = document.getElementById('forum-title');
            const fontSelect = document.getElementById('font-select');
            const userIdDisplay = document.getElementById('user-id-display');
            const userPointsDisplay = document.getElementById('user-points-display');

            const ADMIN_PASSWORD = "Muraba1977";
            const ADMIN_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%233a8cff' d='M12 1L2 5v6c0 5.55 3.84 10.74 9 12a21.46 21.46 0 0 0 9-12V5L12 1Zm0 1.95 7 3V11c0 4.1-2.9 8.24-7 9.87a21.46 21.46 0 0 1-7-9.87V4.95l7-3Z'/%3E%3C/svg%3E";
            const DEFAULT_AVATAR = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ccc' d='M12 2A10 10 0 1 0 12 22A10 10 0 1 0 12 2Zm0 3.75a3 3 0 1 1-3 3A3 3 0 0 1 12 5.75ZM12 20.5a8.5 8.5 0 0 1-6.19-2.5A6.5 6.5 0 0 1 12 14.5a6.5 6.5 0 0 1 6.19 3.5A8.5 8.5 0 0 1 12 20.5Z'/%3E%3C/svg%3E";
            
            const AVATARS = [
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%234a90e2' d='M12 2A10 10 0 1 0 12 22A10 10 0 1 0 12 2ZM6.3 16.8c.8-.4 1.7-.5 2.8-.5a6 6 0 0 1 5.8 4.6l-8.6-4.1Z'/%3E%3C/svg%3E",
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2350e3c2' d='M12 2A10 10 0 1 0 12 22A10 10 0 1 0 12 2ZM8 10a4 4 0 1 1 4 4a4 4 0 0 1-4-4Z'/%3E%3C/svg%3E",
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23f5a623' d='M12 2A10 10 0 1 0 12 22A10 10 0 1 0 12 2Zm0 13a4 4 0 1 1 4-4a4 4 0 0 1-4 4Z'/%3E%3C/svg%3E",
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23bd10e0' d='M12 2A10 10 0 1 0 12 22A10 10 0 1 0 12 2Zm-4 5v10l8-5l-8-5Z'/%3E%3C/svg%3E",
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%239b59b6' d='M12 2A10 10 0 1 0 12 22A10 10 0 1 0 12 2Zm0 13.5a1.5 1.5 0 1 1-1.5 1.5a1.5 1.5 0 0 1 1.5-1.5Z'/%3E%3C/svg%3E",
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%233498db' d='M12 2A10 10 0 1 0 12 22A10 10 0 1 0 12 2Zm.5 14a.5.5 0 0 1-.5.5h-5.5a.5.5 0 0 1-.5-.5v-4.5a.5.5 0 0 1 .5-.5h5.5a.5.5 0 0 1 .5.5Z'/%3E%3C/svg%3E"
            ];
            
            let isAdmin = false;
            let userId;
            let userPoints = 0;
            let userAvatar = DEFAULT_AVATAR;
            let messages = [];

            // Имитация базы данных с использованием localStorage
            const saveToLocalStorage = () => {
                localStorage.setItem('messages', JSON.stringify(messages));
                localStorage.setItem('userId', userId);
                localStorage.setItem('userPoints', userPoints);
                localStorage.setItem('userAvatar', userAvatar);
            };

            const loadFromLocalStorage = () => {
                const savedMessages = localStorage.getItem('messages');
                const savedUserId = localStorage.getItem('userId');
                const savedUserPoints = localStorage.getItem('userPoints');
                const savedUserAvatar = localStorage.getItem('userAvatar');

                if (savedMessages) {
                    messages = JSON.parse(savedMessages);
                }
                if (savedUserId) {
                    userId = savedUserId;
                } else {
                    userId = 'user-' + Math.random().toString(36).substring(2, 9);
                }
                if (savedUserPoints) {
                    userPoints = parseInt(savedUserPoints, 10);
                }
                if (savedUserAvatar) {
                    userAvatar = savedUserAvatar;
                }

                // Обновляем аватар для админа, если он был сохранен
                if (userId === 'admin_user') { // Use a fixed ID for admin to persist state across reloads
                    userAvatar = ADMIN_AVATAR;
                    isAdmin = true;
                    document.body.classList.add('is-admin');
                    adminStatus.textContent = 'Статус: Администратор';
                    adminStatus.className = 'text-sm font-semibold text-green-500';
                }
            };
            
            const updateUI = () => {
                // Обновляем UI пользователя
                userIdDisplay.textContent = `Ваш ID: ${userId}`;
                userPointsDisplay.textContent = `${userPoints} баллов`;
                currentAvatarPreview.src = userAvatar;
                
                // Управление выбором аватара
                if (userPoints > 0 || isAdmin) {
                    avatarSelection.classList.remove('opacity-50', 'pointer-events-none');
                    avatarStatusMessage.textContent = 'Выбирайте аватар';
                } else {
                    avatarSelection.classList.add('opacity-50', 'pointer-events-none');
                    avatarStatusMessage.textContent = 'Наберите 1 балл, чтобы выбрать аватар.';
                }
                
                // Перерисовываем сообщения
                renderMessages();
                updateAvatarSelectionUI();
            };

            const renderMessages = () => {
                messagesContainer.innerHTML = '';
                messages.sort((a, b) => b.timestamp - a.timestamp);

                messages.forEach(msg => {
                    const messageEl = document.createElement('div');
                    messageEl.className = `message-card p-4 rounded-lg shadow-lg transition-transform transform hover:scale-105 ${msg.isAdmin ? 'pulse-animation' : ''}`;
                    messageEl.dataset.id = msg.id;
                    messageEl.dataset.userId = msg.userId;

                    const date = new Date(msg.timestamp).toLocaleString();
                    const senderName = msg.isAdmin ? 'Админ' : 'Пользователь';
                    const senderAvatar = msg.isAdmin ? ADMIN_AVATAR : AVATARS.find(a => a === localStorage.getItem(`userAvatar_${msg.userId}`)) || DEFAULT_AVATAR;
                    const points = msg.points || 0;
                    
                    messageEl.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center text-sm font-semibold text-gray-500">
                                <img src="${senderAvatar}" alt="Аватар" class="user-avatar">
                                <span>${senderName}</span>
                                <span class="text-gray-400 ml-2">(${points} баллов)</span>
                            </div>
                            <div class="text-xs text-gray-500">${date}</div>
                        </div>
                        <p class="text-white text-lg">${msg.text}</p>
                        <div class="admin-controls mt-2 space-x-2 justify-end">
                            <button class="add-points-btn px-3 py-1 bg-green-600 text-white text-xs rounded-md hover:bg-green-700 transition-colors">+1 Балл</button>
                            <button class="delete-btn px-3 py-1 bg-red-600 text-white text-xs rounded-md hover:bg-red-700 transition-colors"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div class="mt-2 text-right">
                            <button class="upvote-btn px-3 py-1 bg-blue-600 text-white text-xs rounded-md hover:bg-blue-700 transition-colors">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                        </div>
                    `;

                    if (isAdmin) {
                        messageEl.classList.add('is-admin');
                    }

                    messageEl.querySelector('.delete-btn')?.addEventListener('click', handleDeleteMessage);
                    messageEl.querySelector('.add-points-btn')?.addEventListener('click', handleAdminAddPoints);
                    messageEl.querySelector('.upvote-btn')?.addEventListener('click', handleUpvote);

                    messagesContainer.appendChild(messageEl);
                });
            };

            const updateAvatarSelectionUI = () => {
                avatarSelection.innerHTML = '';
                AVATARS.forEach(avatarUrl => {
                    const img = document.createElement('img');
                    img.src = avatarUrl;
                    img.className = 'avatar-option';
                    img.dataset.url = avatarUrl;
                    if (userAvatar === avatarUrl) {
                        img.classList.add('selected');
                    }
                    avatarSelection.appendChild(img);
                });
            };

            // Обработка отправки нового сообщения
            newMessageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = messageTextarea.value.trim();
                if (text) {
                    const newMessage = {
                        id: Date.now().toString(),
                        text: text,
                        timestamp: Date.now(),
                        isAdmin: isAdmin,
                        userId: userId,
                        points: 0
                    };
                    
                    messages.unshift(newMessage); // Добавляем в начало
                    messageTextarea.value = '';
                    saveToLocalStorage();
                    updateUI();
                }
            });

            // Обработка входа администратора
            adminLoginBtn.addEventListener('click', () => {
                const password = adminPassInput.value;
                if (password === ADMIN_PASSWORD) {
                    isAdmin = true;
                    // Для сохранения статуса админа, используем фиксированный ID
                    userId = 'admin_user';
                    
                    document.body.classList.add('is-admin');
                    adminStatus.textContent = 'Статус: Администратор';
                    adminStatus.className = 'text-sm font-semibold text-green-500';
                    adminPassInput.value = '';
                    userAvatar = ADMIN_AVATAR; // Обновляем аватар для текущего пользователя
                    
                    saveToLocalStorage();
                    updateUI();
                } else {
                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                            <div class="bg-gray-800 p-8 rounded-lg border border-gray-700 text-white max-w-sm text-center">
                                <p class="mb-4">Неверный пароль администратора.</p>
                                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-red-600 rounded-md">OK</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
            });
            
            // Удаление сообщения (только для админа)
            const handleDeleteMessage = (e) => {
                if (!isAdmin) return;
                const messageId = e.target.closest('.message-card').dataset.id;
                messages = messages.filter(msg => msg.id !== messageId);
                saveToLocalStorage();
                updateUI();
            };

            // Добавление баллов админом
            const handleAdminAddPoints = (e) => {
                if (!isAdmin) return;
                const messageId = e.target.closest('.message-card').dataset.id;
                const messageIndex = messages.findIndex(msg => msg.id === messageId);
                if (messageIndex > -1) {
                    messages[messageIndex].points = (messages[messageIndex].points || 0) + 1;
                    saveToLocalStorage();
                    updateUI();
                }
            };

            // Обработка "лайка" от любого пользователя
            const handleUpvote = (e) => {
                const messageId = e.target.closest('.message-card').dataset.id;
                const messageIndex = messages.findIndex(msg => msg.id === messageId);
                if (messageIndex > -1) {
                    messages[messageIndex].points = (messages[messageIndex].points || 0) + 1;
                    userPoints++;
                    saveToLocalStorage();
                    updateUI();
                }
            };

            // Обработка выбора аватара
            avatarSelection.addEventListener('click', (e) => {
                if (e.target.classList.contains('avatar-option')) {
                    if (userPoints > 0 || isAdmin) {
                        userAvatar = e.target.dataset.url;
                        localStorage.setItem(`userAvatar_${userId}`, userAvatar);
                        saveToLocalStorage();
                        updateUI();
                    } else {
                        const modal = document.createElement('div');
                        modal.innerHTML = `
                            <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                                <div class="bg-gray-800 p-8 rounded-lg border border-gray-700 text-white max-w-sm text-center">
                                    <p class="mb-4">Наберите 1 балл, чтобы выбрать аватар!</p>
                                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-600 rounded-md">OK</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                }
            });

            // Обработка выбора шрифта
            const handleFontSelection = () => {
                const selectedFont = fontSelect.value;
                document.documentElement.style.setProperty('--hacker-font', selectedFont);
                localStorage.setItem('selectedFont', selectedFont);
            };
            fontSelect.addEventListener('change', handleFontSelection);

            // Начальная настройка
            loadFromLocalStorage();
            const savedFont = localStorage.getItem('selectedFont');
            if (savedFont) {
                document.documentElement.style.setProperty('--hacker-font', savedFont);
                fontSelect.value = savedFont;
            }
            updateUI();
        });
    </script>
</body>
</html>
